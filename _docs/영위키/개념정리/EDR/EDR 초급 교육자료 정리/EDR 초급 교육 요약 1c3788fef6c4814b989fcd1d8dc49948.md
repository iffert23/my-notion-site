# EDR 초급 교육 요약

- **참고**
    
    [**https://www.genians.co.kr/support/online_edu**](https://www.genians.co.kr/support/online_edu)
    

---

1. EDR이란
- 단말에 대한 지속적인 모니터링과 상시 정보 수집을 통해 위협을 탐지하고 분석과 대응을 제공하는 단말 이상 행위 팀지 및 대응 솔루션.
- 단말 행위 모니터링 및 수집 (파일, 모듈, 프로세스, 레지스트리, 외부 저장매체 사용현황, 윈도우 이벤트 로그 등)
- 위협 탐지(IOC기반, ML기반, 행위기반, 사용자 설정 기반)
- 위협 탐지 시 대응방법 설정 가능(사용자 알림, 종료, 삭제, 네트워크 격리)
- 탐지된 위협 조사 및 분석(상세 정보 제공, 의심 파일 수집), 이벤트 타임라인 및 연관 분석

---

1. 구성 및 설정
- HW 정보 : ES30_R2(1,500노드 이하 권장), ES50_R2(3,500노드 이하 권장)
- 서버 역할 : Hot, Warm
1. Hot : 쿼리 속도 빠름, 데이터 저장공간 크기 작음, 디스크 비용 비쌈, SSD 사용
2. Warm : 쿼리 속도 Hot보다 느림, 데이터 저장공간 크기 Hot보다 큼, 디스크 비용 Hot보다 저렴, Sata 디스크 사용
- 서버 구성
1. Single 구성(단일) : Hot한 대, 1500~3500노드
2. 클러스터링 구성(분산처리) : ES50_R2 Hot두 대, 3000~7000노드
3. 클러스터링/백업 구성(분산처리, 로그 검색 기간 확장, 백업서버 분리) : Warm으로 ES50_R2 1대, Hot으로 3대, 필요 노드수에 맞출 수 있음
- 모듈
1. Message Server(KafKa) : 로그 분산처리
2. Log Server(ElasticSearch) : 이벤트 로그 저장
3. Manage Server(Apache, Tomcat) : Web Console 사용 및 암호화 통신
4. Data Server(MySQL) : 데이터베이스, 정보저장
5. Treat Detector : 이벤트 위협 탐지 엔진
6. IoC Updater : 악성파일 및 악성네트워크주소의 업데이트 정보를 수신해오는 모듈
7. NFS Server : 로그 백업파일 저장 시스템
8. FS Backup : ES snapshot을 원격 저장장치로 백업

---

1. Agent 설치
- 에이전트 운영모드 (adv 페이지에서 설정)
1. NAC 플러그인 : 기존 NAC 플러그인으로 동작, 통합 에이전트 트레이 지원, 사용자정보, DeviceID 동일
2. 단독버전 : 단독 에이전트 동작, 자체 인사DB, Device ID
3. 단독버전+NAC 연동 : Icon 통합여부 선택 가능, 기본적으로 단독버전과 동일
- 동작 순서
1. 설치 후 : Agent 설치 -> API를 이용해서 엔드포인트 등록 후 정책 수신(TCP 443) -> SSL 통신으로 서버와 인증 후 Agent 수집 이벤트 전송 (TCP 3876) -> UDP 3880 KA 주기적 전송
2. 정책 적용 : 서버에 정책 적용 -> Threat Detector에 명령 전달 -> UDP 3880으로 Agent에 신호 전달 -> 신호 수신 -> 정책 수신 (TCP 443) -> 정책 즉시 적용

(실습 1)

1. NAC 에이전트 설치
2. 노드그룹 생성
3. Threat Detector2 플러그인 설정
4. 노드정책 생성 후 플러그인 추가
5. EDR 에이전트 정상 설치 여부 확인

---

1. 이벤트 수집
- 이벤트 타입 : File, Process, Module, Network, Registry
- File : 실행파일 생성/수정, 문서/압축파일의 생성/수정/이동, FileUpload 와 관련한 모든 이벤트, DocPrint 이벤트, DocOpen 이벤트 수집
- Process : 모든 프로세스 이벤트 수집
- Module : 모든 DllInject, DllInjected 이벤트, 유효하게 전자서명되지 않은 ModuleLoad 이벤트
- Network : DstPort가 137/UDP, 138/UDP, 139/UDP, 5535/UDP가 아닌 모든 이벤트, 모든 TCP Port 이벤트
- Registry : 중요 레지스트리에 대한 이벤트
- 이벤트 수집 추가/예외처리 가능
- 윈도우 이벤트 수집 지정된 이벤트만 실시간 수집하는 게 목적
- 커스텀 윈도우 이벤트 추가 옵션을 통해 추가적으로 수집할 이벤트 지정 가능

(실습 2)

1. 그룹정책 생성, 정책 할당
2. 테스트 프로그램 다운로드 및 실행하여 로그 기록되는 것 확인
3. 이벤트 수집 예외 설정
4. 생성한 정책에 예외설정 추가, 즉시 재적용
5. 프로그램 실행하여 로그 기록 여부 확인 (로그 기록 안되면 성공)

(실습 3)

1. 윈도우 이벤트뷰어에서 수집하고자 하는 이벤트의 XML 확인
2. 이벤트ID, 채널 경로 확인
3. 커스텀 윈도우 이벤트에 정보 추가 (XBA 탐지 off)
4. 정책 즉시적용, 로그 확인 (이벤트 수집되면 성공)

---

1. 로그/이벤트 검색, 대시보드 활용
- 분석/통합검색 두 가지 형태로 로그 검색 가능
- 분석-이벤트 조사 창에서 여러가지 검색조건 설정하여 이벤트 검색 가능
- 자주 쓰는 검색조건은 즐겨찾기 등록
- 다양한 인덱스 종류에 따라 각 인덱스 안의 이벤트 검색 가능
- 대시보드는 일반/분석 두 가지 형대로 생성 가능
- 분석 대시보드에는 검색창있음
- 여러가지 위젯으로 대시보드 구성 가능
- 위젯 생성 시 여러 조건 설정 가능

(실습 4)

1. 이벤트 조사 검색창에 FileName:*pptx AND ProcName:kakaoTalk.exe AND EventSubType:"FileUpload" 검색
2. 다른 조건으로 검색해서 원하는 로그 나오는지 확인

(실습 5)

1. 분석 대시보드 탭 새로 생성
2. 위젯 만들기 (기본 그리드, 기본 Pie 차트, 다중 빅넘버)
3. 제목 : 외부 업로드 관련으로 설정, 조건 : ventSubType:FileUpload AND FileName.raw:("*.pptx" OR "*.docx" OR "*.xlsx" OR "*.xls" OR "*.doc" OR *.ppt OR *.hwp OR *.pdf OR *.pptx OR *.docx OR *.xlsx OR *.xls OR *.doc OR *.ppt OR *.hwp OR *.pdf) AND !FileName.raw:/[~$].*/ AND NOT ProcName:SYSTEM
4. 만든 위젯들간의 연결 설정

---

1. 악성코드 탐지 및 대응
- 위협탐지 : IoC(악성파일) 탐지, ML(멀웨어) 탐지, XBA(이상행위) 탐지, CTI (평판조회, 유사도 정보)
- 위협관리 : 위협으로 탐지된 내용을 확인하여 악성, 보류, 안전 등으로 위협 판정을 내릴 수 있으며 위협으로 처리되지 않게끔 예외규칙도 추가 가능하다.
- 위협분석 : 위협관리에서 위협으로 탐지된 내용에 대해 상세하게 확인할 수 있음
- 위협대응 : 그룹정책에 사전에 정의된 내용에 따라 탐지와 동시에 자동으로 대응하는 자동대응과 대응되지 않은 위협이나 이미 자동적으로 대응된 위협에 대해서 관리자가 수동으로 대응하는 수동 대응이 있다. 종류에는 탐지만 수행, 알림, 프로세스 강제종료, 파일삭제 가 있다.
- 프로세스 : 탐지 -> 진단 -> 분석 -> 대응
- XBA 커스텀 룰 메뉴에서 기본 제공하지 않거나 필요한 패턴의 룰을 직접 생성하고 관리할 수 있다.

(실습 6)

1. 그룹정책 생성, 그룹 할당, 그룹에 단말 할당
2. 악성코드로 분류할 테스트파일의 MD5해시를 추출해서 Malware Hash로 등록
3. 파일이 악성코드로 분류되는지 로그를 확인
4. 파일을 실행하거나 복사하여 위협 탐지 여부를 확인
5. 악성코드 탐지시 에이전트 알림 메시지 또는 파일삭제로 설정하여 대응되는지 확인

(실습 7)

1. 정책->이상행위 룰셋에서 이상행위 정책 생성
2. 그룹 정책에서 탐지 -> 이상행위 룰셋에 본인이 만든 정책 할당
3. 이상행위 룰셋에 룰(진단규칙) 추가
4. 설정한 진단규칙에 대한 행위(파일 업로드 등) 수행 시 이상행위 탐지 여부 확인
5. 비슷한 방법으로 진단 예외 규칙도 설정해보기

---

1. 유지관리
- 서버 점검(ElasticSearch) : 인덱스별 저장 용량 확인, 메모리 확인, 로그상태 백업 확인, 인덱스 헬스 확인 [Green(정상), Yellow(일부 에러, 자체 복구 가능), Red(자체 복구중일 가능성 있음, 백업중에 발생), Down(이상 발생)]
- 이벤트 점검(ES Console) : 일별 이벤트 수집량 확인(ES Console/CLI), 이벤트 저장 일 수 계산, 이벤트 전송여부 및 KafKa 통신 확인
- 에이전트 점검 : 이벤트 전송 불가 / 수집 불가 로그 유무 확인, 에이전트 설치, 위협 탐지, 예외, 대응 로그 확인
- 위협 처리 현황 확인

---

1. syslog 연동
- EDR 로그를 타 솔루션으로 전송하는 기능
- 관리-설정 -> 환경설정-외부연동 -> SYSLOG 전송 -> 서버 IP 및 프로토콜, 인덱스 등 설정 가능
- 인덱스 종류별로 확인할 수 있는 이벤트 종류가 다름. 분류표 보고 확인하여 설정

(실습 8)

1. PC에 syslog server 프로그램 설치하여 syslog를 받을 수 있는 환경 구성
2. EDR의 syslog 설정에서 서버 IP는 본인 PC IP, 프로토콜 UDP, 전송포트 514, 인덱스, 필터, syslog 메시지 설정
3. 이상행위 룰셋 신규 설정 (ping.exe)
4. 이상행위 발생 시 syslog 수신되는지 확인

---

1. 안티랜섬 모듈
- 안티랜섬 : 랜섬웨어 차단을 위한 행위 기반 탐지, 실시간 백업 및 복원, 주요 서버 파일 보호 기능을 제공
- 안티랜섬 포함 라이선스 등록해야 안티랜섬 모듈 사용 가능 (정책 설정에서 추가됨)
- UI에서 노드별 안티랜섬 모듈 동작상태 확인 가능
- 탐지 즉시 대응여부 설정할 수 있음, 기본적으로 파일 백업함, 추가로 어떤 대응을 할 지 설정 가능, 관리자가 악성/안전 처리 여부에 따라 대응이 달라질 수 있음
- 대응 방법 : 프로세스 강제종료, 프로세스 파일 삭제, 프로세스 실행 차단, 변조 파일 삭제, 자동 문서 복원, 파일 백업
- 운영모드(안티랜섬 사용 기준) : Active(수동복원), Active(자동복원), Monitoring(탐지만)
- 안티랜섬 탐지 정책 추가 제공
- 안전 및 예외처리 조건 설정 가능

(실습 9)

1. 안티랜섬 플러그인 사용여부 확인
2. 모니터링 모드로 설정
3. PC에 테스트 폴더 생성, Ransomware_EDRTest.exe 랜섬웨어 파일 및 기타 파일 추가
4. CMD에서 Ransomware_EDRTest.exe –rek 명령어 수행
5. 위협 탐지 확인

---

1. EDR 초급 라이선스 평가

---