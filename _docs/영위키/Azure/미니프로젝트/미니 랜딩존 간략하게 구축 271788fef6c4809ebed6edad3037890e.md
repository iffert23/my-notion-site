# 미니 랜딩존 간략하게 구축

---

<아키텍쳐>

![숙제 아키텍쳐.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/%EC%88%99%EC%A0%9C_%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90.png)

<전체적인 구축 순서>

RG 생성 → vNet 생성 → vNet Peering → VM 생성 → AG 생성 → VPN 생성 →  Storage 생성 → Postgre 생성 → Private Endpoint 생성 → Private DNS 생성

1. RG 3개
    
    ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image.png)
    
2. vNet 2개
    
    ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%201.png)
    
    Prod 구성
    
    - Address space : 10.10.0.0/16
    - subnet 구성
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%202.png)
        
        - subnet 구성할 때 gateway subnet은 subnet purpose를 virtual network gateway로 설정해야함. prefix 27
    - Dev 구성
        - Address space : 10.20.0.0/16
        - subnet 구성
            
            ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%203.png)
            
    - Peering
        - 양쪽에 peer1, peer2로 피어링 구성
            
            ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%204.png)
            
3. VM 생성
    - nginx 올리기에 리눅스가 간편할 것 같아서 리눅스 서버로 생성함
    - public ip 사용하지 않음(초기세팅에 필요할까 싶어서 생성해뒀었는데 VPN 연결하고 초기설정 진행한다고 하면 필요없음)
    - auto-shutdown 걸어둠 (시간 잘못 설정해서 UTC 오후 7시 됨;;)
    - 스펙
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%205.png)
        
4. VM에 대한 NSG 설정
    
    ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%206.png)
    
5. AG 설정
    - backend pool : VM
    - backend setting : port 80 (외 다른 설정 기본)
    - frontend ip : public, private 둘 다 생성시에 적용. private ip는 직접 지정해줘야 함
    - listener : port 80으로 이름만 다르게 두 개 생성해서 frontend ip에 할당
    - ag rule : rule 01, 02로 이름만 다르게, listener도 각각 다르게, backend targets는 rule 상관없이 똑같은거 선택해도 됨
    - 아직 VM에 nginx 설정 안했기 때문에 80포트 통신 확인 안될 것.
6. VPN 구성
    - config 구성
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%207.png)
        
    - P2S 설정
        
        자세한 내용은 아래 페이지에 있음. 비슷함.
        
        [P2S 테스트](../Test%20Achive/P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8%2025b788fef6c48053a8b0d44a953f4607.md)
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%208.png)
        
7. VPN 연결해서 VM에 nginx 설치
8. Storage account 생성
    - storage account 생성 시 name은 글로벌 누구와도 겹치지 않는 name으로 설정해야 함. 테스트용이라 그냥 Redundancy LRS로 함
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%209.png)
        
    - 그 외 Advances(블랍으로 설정), Networking, Data protection, Encryption, tags는 기본값.
    - 이 단계에서 private endpoint 만들지 않음. 걍 내맘임. 나중에 한번에 만들거임.
9. Postgre 생성
    - Postgre SQL은 flexible로 생성함
    - name, region 설정, version은 기본설정으로
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2010.png)
        
    - compute + storage 설정은 아래와 같이 (테스트용이기도 하고 디비를 넘기는게 아니기때문에 제일 싼걸로)
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2011.png)
        
    - Authentication(인증은 비밀번호 방식으로 설정)
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2012.png)
        
    - Networking에서 connectivity : public access, 밑에 public access는 끄고, private endpoint 생성 (이건 지금 해도 됨)
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2013.png)
        
    - Private endpoint 생성
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2014.png)
        
    - firewall rule 안만듦
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2015.png)
        
    1. Private Endpoint 생성
    - storage account - networking - private endpoints - create
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2016.png)
        
    - 이름 설정
    - sub-resource : blob
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2017.png)
        
    - vnet 설정
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2018.png)
        
    - DNS 설정
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2019.png)
        
    - create
10. 생성된 각각의 private endpoint에 NSG 정책 추가
    - RG 1의 storage account
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2020.png)
        
    - RG 2의 storage account
        
        ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2021.png)
        
11. Private DNS 확인
    - blob
    
    ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2022.png)
    
    - postgre
    
    ![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2023.png)
    
12. 통신확인

![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2024.png)

![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2025.png)

![image.png](%EB%AF%B8%EB%8B%88%20%EB%9E%9C%EB%94%A9%EC%A1%B4%20%EA%B0%84%EB%9E%B5%ED%95%98%EA%B2%8C%20%EA%B5%AC%EC%B6%95/image%2026.png)