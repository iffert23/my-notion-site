# P2S 테스트

---

# Entra ID로 인증

### Enterprise application 권한

1. Enterprise Application [Azure VPN]에 대한 전역 관리자 권한이 있는지 확인이 필요함
    
    ```jsx
    https://entra.microsoft.com/#view/Microsoft_AAD_IAM/EntraLanding.ReactView
    ```
    
2. 아래 링크에서 **common** 부분을 테넌트 ID로 바꾼 다음에 웹에 붙여넣기
    
    ```
    https://login.microsoftonline.com/**common**/oauth2/authorize?client_id=41b23e61-6c1e-4545-b367-cd054e0ed4b4&response_type=code&redirect_uri=https://portal.azure.com&nonce=1234&prompt=admin_consent
    ```
    

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image.png)

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%201.png)

만약에 권한 없으면 관리센터>개요>밑으로 좀 내려서 PIM 메뉴 선택>내 역할>작업 활성화

1. 테넌트ID, Object ID 확인
Azure Microsoft Entra ID>Overview에서 테넌트 ID확인>Enterprise applications>Azure VPN 검색>Overview 에서 Object ID 확인

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%202.png)

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%203.png)

### 테스트 환경 구축

1. vWAN 생성
    
    구독, 리소스 그룹, 리전, 이름, 타입(standard) 설정 후 만들기
    
2. 허브 생성
    
    그냥 깡통 허브 생성(나중에 vpn user profile 만들고 p2s GW 만들거임)
    
    허브 address는 23비트로 설정
    
    Hub routing preference 는 VPN으로 설정해도 되고 ER로 설정해도 되는데 난 VPN으로 설정함
    

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%204.png)

1. vNet 생성
    
    Security는 상황에 맞춰 추가, 나는 기본설정대로 아무것도 선택하지 않음
    
    IP address 는 vhub와 겹치지 않는 대역으로 설정(당연함)
    

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%205.png)

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%206.png)

1. VM 생성
    
    VM에 VPN 설치해서 로컬로 연결할 거 아니면 VM은 뭐든 상관없음. 일단 테스트는 windows만 해봄
    
    표시한거 빼고 다 기본설정
    

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%207.png)

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%208.png)

![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%209.png)

### P2S 연결

1. User VPN configurations
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2010.png)
    
    다른 옵션은 미사용, Azure Active Directory 사용으로 설정
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2011.png)
    
    Audience : Azure VPN application ID
    
    Issuer : https://sts.windows.net/테넌트 ID/
    
    AAD Tenant : https://login.microsoftonline.com/테넌트 ID/
    
    *모든 테넌트 ID 뒤에 /(슬래시) 꼭 붙어야 함 안그러면 VPN 연결 안 됨..
    
2. vNet connection 생성
    
    커넥션 이름, 허브, 구독, 리소스그룹, vnet 설정
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2012.png)
    
3. vHub에 P2S VPN Gateway 생성
    
    해당되는 vhub에서 scale units, 미리 만들어둔 user vpn config선택, address path 설정
    
    address path는 vnet과 vhub, 온프렘 대역과 겹치지 않는 대역으로 임의설정하면 됨
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2013.png)
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2014.png)
    

### 테스트

1. Azure Client 설치
    
    https://apps.microsoft.com/detail/9np355qt2sqb?hl=ko-KR&gl=KR#activetab=pivot:overviewtab
    
2. 가상 허브 사용자 VPN 프로필 다운로드
    
    인증 형식 [EAPTLS] 선택하여 파일 다운로드
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2015.png)
    
    폴더 압축해제
    
    AzureVPN→azurevpnconfig파일 확인
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2016.png)
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2017.png)
    
3. VPN Profile 업로드
    
    Azure VPN Client열기 → +버튼 클릭 → 가져오기 → azurevpnconfig 열기 → 저장
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2018.png)
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2019.png)
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2020.png)
    
4. ping 테스트
    
    저장된 vpn 연결해서 entra id로 로그인
    
    ping 테스트 (온프렘 → 다른 리전의 VM)
    
    캡처화면은 없지만 ping 정상이고 해당 VM의 private IP로도 정상적으로 RDP 통신되는 것 확인
    
    ![image.png](P2S%20%ED%85%8C%EC%8A%A4%ED%8A%B8/image%2021.png)
    

# 인증서로 인증

### 음 뭐부터?