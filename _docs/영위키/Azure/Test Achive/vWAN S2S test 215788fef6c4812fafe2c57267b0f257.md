# vWAN S2S test

---

https://learn.microsoft.com/ko-kr/azure/virtual-wan/virtual-wan-site-to-site-portal

- host - S2S(instance 1, 2) - 서울 UTM  - KoreaCentral vWan/vHub - AZ 백본 - Southeast vWan/vHub - 부산 UTM - S2S(instance 1,2) - 부산 host

vWAN에 vHub 두 개 추가 (korea central, Southeast central)

korea central

- vNet1, 2 생성
- 각 vNet에 vm 1개씩 생성
- NSG 생성 — vnet 연결 — 이런저런 규칙 추가(ping 및 ssh 가능하게끔)
- vWAN 생성
- vHub 생성
    - 주소 공간 할당
    - 용량 설정
    - 라우팅 기본 설정 VPN으로 함
    - S2S VPN Gateway 생성
- S2S VPN GW 설정
    - VPN Site 신규 생성
        - name, Device vendor(대충메모용), Private address space(목적지 ip대역)
        - Private address space 안쓰고 넘어가도 되는데 안쓰고 넘어가면 다음 link 설정에서 BGP address랑 Link ASN 빈칸 안되고 무조건 설정해줘야 함
        
        ![스크린샷 2025-09-02 133712.png](vWAN%20S2S%20test/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7_2025-09-02_133712.png)
        
    - Link 추가
        - Link name, Link provider name, Link Speed, Link IP address(공인IP?누구의?), Link BGP address랑 Link ASN은 선택사항 (빈칸가능)
        - 위에서 Private address space 입력시에만 BGP 관련 설정 안해도 됨
        
        ![스크린샷 2025-09-02 133926.png](vWAN%20S2S%20test/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7_2025-09-02_133926.png)
        
    - 설정값 확인 (인스턴스별 Public, Private, BGP IP)
        
        ![저기서 필터 Connected부분 X버튼으로 지우면 추가한 VPN 사이트 설정 나옴](vWAN%20S2S%20test/image.png)
        
        저기서 필터 Connected부분 X버튼으로 지우면 추가한 VPN 사이트 설정 나옴
        
    - 생성한 VPN site 체크박스 클릭하고 Connect VPN site
        
        Protocol, IPSec 설정 후 connect 버튼 클릭
        
        ![image.png](vWAN%20S2S%20test/image%201.png)
        
- vWAN 설정(선택)
    - 가상 네트워크 연결 - 연결 추가 - 이름, 연결할 허브, 리소스 그룹, 연결할 vNet 등등 옵션 선택해서 만들기
    - 
- VM 생성 공용ip 할당함

S2S 연결할때 vhub쪽 인스턴스 두개랑 UTM포트 하나 연결하는게 왜 좋은지 내일까지 팀장님한테 설명할수있도록 하기

https://learn.microsoft.com/ko-kr/azure/vpn-gateway/about-active-active-gateways#active-active-mode-design

- 풀 매시로 온프레미스 장비와 연결하는 것이 좋겠지만 온프렘장비 하나의 포트와 active-active 상태의vhub gw 두개를 연결하는 게 좋은 이유는
- 단일 포트 단일 터널 /  단일 포트 액티브 액티브 연결 / 풀 매시 연결
1. active-active 구성되어있을 때 어떤 이유에서건 하나의 터널이 통신 불능 상태가 돼도 active 상태의 터널로 자동으로 통신하게 되어서 무중단으로 운영된다.
2. 근데 테스트를 해보니까 완전히 무중단은 아닌 것 같고 약간 통신 지연이 발생했다.
3. 페일오버를 진행하며 문제가 발생한 쪽 터널에 설정되어 있던 라우팅을 삭제하기 때문에 해당 과정에서 약간의 통신지연이 발생할 수 있다.
4. 그렇게 되는 이유는 vWAN/vHub에서 항상 모든 통신을 양쪽 터널에 동시에 라우팅해주기 때문이다
5. 만약에 정상적으로 통신되고 있던 두 터널 중 하나의 터널에 문제가 발생한다면 dead peer detection timeout 시간인 45초 이내에 연결 끊김을 방지하고 자동으로 끊긴 터널이 아니라 이미 활성화되어있는 다른 터널로 통신이 정상적으로 수행될 수 있도록 페일오버를 진행한다.

근데 터널 인스턴스가 만약에 둘 다 죽었다!!! 이러면 그걸 누가 대체하냐?

⇒ 애저의 우리 눈에 보이지 않는.. 인스턴스가 속해있는 거대한 서버팜 속에 눈에 보이는 인스턴스의 뒤에 무수히 많은 숨겨진 백업 인스턴스들이 있고 걔네가 바로 죽은 인스턴스를 대체할것이다~

ECMP 생각을 왜 애매하게 했지. 바본가

터널 ecmp 설정에 관하여

https://learn.microsoft.com/ko-kr/azure/vpn-gateway/vpn-gateway-highlyavailable

https://learn.microsoft.com/ko-kr/azure/virtual-wan/path-selection-multiple-links

ㄴ> 가상 허브 VPN은 모든 종료 터널에서 ECMP(동일한 비용 다중 경로 라우팅)를 사용한다는 점에 유의해야 합니다. 가 핵심

경로 선택 우선순위는 애저에서 할 수 없고 해당 동작을 수행하는 기타 디바이스에서 설정하는 우선순위 정책에 따라 트래픽 분산(ECMP)이 가능함

비용 : 각각의 VPN Site마다 과금됨. 그 사이트 안에 등록되어있는 링크의 개수는 과금에 영향을 주지 않음

https://learn.microsoft.com/ko-kr/azure/virtual-wan/pricing-concepts