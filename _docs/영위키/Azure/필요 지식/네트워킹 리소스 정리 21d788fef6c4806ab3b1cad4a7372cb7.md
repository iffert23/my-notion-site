# 네트워킹 리소스 정리

---

internal, external LB, Azure FW, Azure WAF, Network Gateway

---

네트워크 기반

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image.png)

**Virtual Network(가상 네트워크)**

- 말 그대로 가상 네트워크. 프라이빗 네트워크 환경 구성을 위한 기본 리소스
- https://learn.microsoft.com/ko-kr/azure/virtual-network/quickstart-create-virtual-network?tabs=cli
- https://learn.microsoft.com/ko-kr/azure/virtual-network/virtual-networks-faq#what-address-ranges-can-i-use-in-my-vnets
- 구독 선택 - 리소스 그룹 선택/생성 - 가상 네트워크 이름 설정 - 지역 설정 - 보안 설정 - 서브넷 설정 - 태그 설정(선택) - 검토+만들기
- 보안
    - [**가상 네트워크 암호화**](https://learn.microsoft.com/ko-kr/azure/virtual-network/virtual-network-encryption-overview)
        - vNet 안에서 일어나는 트래픽을 DTLS 터널을 만들어 VM간의 트래픽을 암호화 하는 옵션.
        - 피어링 된 vNet 간의 트래픽도 암호화한다.
        - 암호화 옵션을 사용하려면 VM에서 ‘가속화된 네트워킹’ 옵션을 사용해야함. 근데 해당 옵션을 사용할 수 있는 VM은 스펙이 4코어가 넘어야 하고, 가능한 인스턴스들이 정해져 있다.
        - vNet 암호화 사용 설정 후에는 기존 VM의 시작/중지가 필요하다
        - Internal Load Belencer가 있는 경우는 암호화가 지원되지만, DNS Private Resolver, Application Gateway, Azure Firewall을 지원하지 않음
    - [Bastion](https://learn.microsoft.com/ko-kr/azure/bastion/bastion-overview)
        - 개인 IP 주소를 통해 VM에 안전하게 연결하기 위해 프로비전하는 완전 관리형 PaaS 서비스.
        - Azure Portal이 가진 TLS를 통해서 직접 연결하거나 로컬 컴퓨터에 이미 설치된 SSH/RDP 클라이언트를 사용해서 VM에 연결할 수 있도록 지원해준다 (VM에 공용IP 필요없음)
        - Bastion서브넷에 NSG 적용 필요 없음, Bastion의 RDP/SSH만 허용하도록 NSG를 구성할 수 있다
        - VM에서 별도로 Bastion host를 관리할 필요가 없다
        - VM이 외부에 공개될 필요가 없기 때문에 보안성이 좋다
        - SKU 별 기능이 다르기 때문에 주의해야 한다
    - Azure Firewall
        - 말그대로 Azure Firewall을 vNet안에서 사용할건지 체크하는 부분. 굳이 체크하지 않고 넘어가도 추가적으로 생성할 수  있을 것으로 보인다.
    - Azure DDoS 네트워크 보호 (DDoS Protection)
        - DDoS Protection 리소스를 먼저 만들어놓고 vNet에 연결하는 것.
        - https://learn.microsoft.com/ko-kr/azure/ddos-protection/manage-ddos-protection
- [IP주소](https://learn.microsoft.com/ko-kr/azure/virtual-network/virtual-network-vnet-plan-design-arm#subnets)
    - 주소 공간 : 사용자 지정 개인 IP 주소 할당 가능한 공간
    - 서브넷 : 주소 공간의 일부를 각 가상 네트워크의 하위 네트워크로 분할하여 할당할 수 있다
    - 서브넷 이름 설정
    - IP 주소 범위 설정
    - 프라이빗 서브넷 —?
    - 보안
        - NAT 게이트웨이
        - 네트워크 보안 그룹
        - 라우팅 테이블
    - 서비스 엔드포인트 —?
    - 서브넷 위임 —?
    - 프라이빗 엔드포인트에 대한 네트워크 정책 —?

---

하이브리드 연결

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%201.png)

**Virtual WAN**

- vWAN
    - 설정 - 구성 —
        - 가상 WAN 유형 표준 / 기본 차이점 —
            
            
            | 표준 | 기본 |
            | --- | --- |
            | S2S, P2S, P2P, ER, vNet 간, 허브 간 Any-to-Any 연결 | S2S, P2S, P2P, vNet 간 연결 |
            | 허브가 기본적으로 풀 매시로 연결됨 | 허브가 서로 연결되지 않음 |
        - 허브 간 연결 사용 — 기본이면 사용안함, 표준이면 사용함으로 설정됨
        - 분기 간 연결 사용 안함/사용함 차이점 — 분기(VPN/SD-WAN 디바이스) ?
    - 설정 - 잠금 — 리소스 삭제 또는 변경 방지를 위한 기능. 삭제 방지(delete), 읽기 전용(Read-Only) 가 있음
    - 연결 - 허브 — 밑에 정리
- [Virtual Hub](https://learn.microsoft.com/ko-kr/azure/virtual-wan/hub-settings)
    - vHub 만들 때 배율 : 1 Unit으로 설정함(테스트용이라면)
    - VPN (사이트 간) — S2S VPN
        - S2S GW 생성 시 scale unit은 테스트용이라면 1로 선택하고 Routing preference는 MS Network로 선택 - [이유](https://docs.microsoft.com/azure/virtual-network/routing-preference-overview)
        - 게이트웨이 구성 배율 —네트워크 처리량, 연결 VM 수를 계산한 예상치에 맞는 배율을 선택한다.
            - 예상 처리량 측정 방법 : 모니터링 도구를 사용해서 트래픽 분석, 예상 사용자 수 기반 추정, 애플리케이션 특성 기반 추정, 부하 테스트 도구 사용하여 측정
            - VPN Gateway 인스턴스가 gateway scale unit임 — 아님..
                
                ![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%202.png)
                
            - 인스턴스의 개수는 2개로 고정되어 있으며 Scale Unit의 개수는 처리량을 결정한다.
            - Scale Unit 수정하는거 1시간 걸림
        - NAT 규칙 — VPN GW를 통해 들어오고 나가는 트래픽에 대해서 NAT를 할 지, 어떤 걸 할 지 설정할 수 있다
            - Name : 이름 지정
            - Type
                - Dynamic : IP 주소를 다른 대상 IP/포트로 변환할 수 있다. 다수의 내부 IP를 소수의 외부 IP로 변환하는 목적
                - Static(주소를 고정하여 매핑. ex:10.0.0.1 →NAT→192.168.0.1) ⇒ 대상 ip pool이 원래 pool과 동일하다면 static, 아니면 dynamic
            - IP Configuration ID : GW 인스턴스 설정 (Dynamic인 경우에만 설정 가능.)
                - 인스턴스를 식별하는 값이다.
                - Dynamic NAT는 특정 인스턴스에만 적용이 가능하며 각 인스턴스 별로 별도의 NAT Rule을 지정해야 한다.
            - Mode
                - IngressSnat : SNAT(출발지 소스 nat)인데 외부에서 들어오는 경우에 외부의 출발지 IP를 변환하여 내부에 들어오게 함
                - EgressSnat : SNAT인데 내부에서 나가는 경우에 내부 IP를 변환하여 나감
            - Internal Mappings : 내부 네트워크 원본 IP 주소 대역
            - External Mappings : 외부 네트워크 대상 IP 주소 대역
            - Internal Port Mappings : 내부 네트워크 원본 port 주소 대역
            - External Port Mappings : 외부 네트워크 대상 port 주소 대역
            - VPN Link Connection : VPN Site를 vWAN vHUB의 S2S VPN GW에 매칭함
                - VPN Site를 만들어놔야 select가 가능한 것으로 보임
        - S2S 추가 -
            - Region : 해당 허브 있는 위치로 맞춰줌
            - Name,Vandor는 재량껏
            - Private address space : 목적지 ip 대역 또는 ip주소/prefix
            - Links - name, speed, provider name 대충 써도 됨 Link IP address부분은 상대UTM 쪽 공인ip 넣음
            
            ![공인IP 자리](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%203.png)
            
            공인IP 자리
            
            - BGP Address, ASN 필요 없다면 빈칸으로 설정해도 정상적으로 생성됨
        - Connect VPN Sites
            - PSK 설정
            - Protocol IKEv2
            - IPsec Custom (필요에 따라 달라짐. 아래는 테스트설정)
                - SA Lifetime in seconds : 2700
                - IKE Phase 1 : AES256, SHA256, DHGroup14
                - IKE Phase 2 : AES256, SHA256, None
            - Propagate Default Route : Disable
            - Use policy based traffic selector : Disable
            - Configure traffic selector : No
            - Connection Mode(필요에 따라 달라짐) : Responder Only
        - VPN Site 연결 확인하는 법
            - Site 설정해둔 거 눌러서 해당 링크 Connectivity status 확인
        - 메트릭 확인 가능
    - ER(GW 만두는거 되게 오래걸림), P2S …
    - 라우팅 - 경로 맵 - 규칙 추가
        - name, Next step, Match Condition(Property,Criterion,Value), Action, Route Modifications(Property,Criterion,Value) — 옵션
        - Match Condition
            - Property(ex.Value) : Route-prefix(BGP 대역, 10.1.0.0/16, 10.2.0.0/24), Community(BGP 커뮤니티. 속성 또는 태그, 65001:100, 65001:200), AS-Path(AS 경로, 65001, 65002, 65003)
            - Criterion : equals(값이 순서까지 동일해야 함), contains(순서에 상관 없이 해당 값을 포함하고 있기만 해도 됨. prefix의 경우는 10.1.1.0/24 대역이 값이라면 10.1.0.0/16 대역도 값으로 포함함)
        - Action : Drop / Modify
        - Route Modifications (Action이 Modify일 경우만 유효)
            - Property(ex.Value) :
            - Action :
    - 라우팅 의도? 라우팅 정책?
    - BGP Peer —?
    - Route Tables —?
    - Effective Routes —활성(유효)한 라우팅 경로를 볼 수 있음?
    - S2S VPN, ER, P2S GW을 가지고 있을 수 있다. vWAN을 사용하는 경우에는 vNet과 온프레미스를 바로 연결하는게 아니라 vHub 게이트웨이를 통해 vNet으로 이동하는것.
    - vHub GW는 ER과 VPN GW에 사용하는 vNet GW와 다르다
    - 지역 설정, 이름 설정
    - 허브 프라이빗 주소 공간 — vNet 대역, 온프렘 대역과 겹칠 수 없음 / prefix 23비트
    - 가상 허브 용량 —어느정도로 설정? / 자동 조정 기능 있음
    - 허브 라우팅 기본 설정 —ER? VPN? AS경로? — [링크](https://learn.microsoft.com/ko-kr/azure/virtual-wan/about-virtual-hub-routing-preference)
    - NVA..모야.. 네트워크 가상 어플라이언스?
    - vHub Gateway(S2S, P2S, ER 설정 시 배율 선택 필요). [참고](https://learn.microsoft.com/ko-kr/azure/virtual-wan/gateway-settings)
    - 가상 허브 라우팅 상태 : 프로비저닝됨, 프로비저닝중, 실패(오류발생), 없음(프로비전X)
    - vNet 연결 : vWAN 내에서 뭔가 수정/배포/생성중일땐 기능 추가 설정 안된다.
    - 
- 

네트워크 보안

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%204.png)

Load Balancing

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%205.png)

Content delivery

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%206.png)

Monitoring

![image.png](%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9%20%EB%A6%AC%EC%86%8C%EC%8A%A4%20%EC%A0%95%EB%A6%AC/image%207.png)

추가 네트워킹 서비스