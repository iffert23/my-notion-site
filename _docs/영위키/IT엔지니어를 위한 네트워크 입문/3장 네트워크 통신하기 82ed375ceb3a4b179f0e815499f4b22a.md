# 3장/ 네트워크 통신하기

---

### 3.1 데이터를 전송할 때 사용하는 통신 방식

- 유니캐스트
    - 출발지와 목적지가 1:1 통신
    - 목적지가 정해져 있음
- 브로드캐스트
    - 1:모든 통신
    - 동일 네트워크에 존재하는 모든 host에게 통신 (광고)
    - 유니캐스트로 통신하기 전, 목적지의 정확한 위치를 알기 위해 사용
- 멀티캐스트
    - 1:다수(모든통신아님)
    - 하나의 출발지에서 다수의 특정 목적지로 감
- 애니캐스트
    - 1:1통신 (목적지는 동일 그룹내의 1개의 호스트)
    - 다수의 동일 그룹 중 가장 가까운 host에서 응답

<aside>
💡 BUM 트래픽
Broadcast, Unknown Unicast, Multicast 약어.
유니캐스트이지만 실제로 겉으로 보이는 동작 방식은 브로드캐스트.

</aside>

### 3.4 TCP와 UDP

TCP/IP 스택의 4계층에서 동작하는 TCP, UDP 프로토콜

**3.4.1 4계층 프로토콜**

인캡슐레이션, 디캡슐레이션 중 가장 중요한 두 가지 정보

- 각 계층에서 정의하는 정보 (출발지MAC, 도착지MAC)
    - 2계층 : MAC, 3계층 : IP, 4계층 : Seq 번호, ACK 번호
- 상위 프로토콜 지시자 정보 (Ether Type)
    - 2계층 : Ether Type, 3계층 : Protocol Number, 4계층 : 출발지 포트, 목적지 포트

목적 : 애플리케이션에서 사용하는 프로세스를 정확히 찾아가고 데이터를 분할한 패킷을 잘 쪼개 보내고 잘 조립하는 것

TCP 프로토콜 : 분해(시퀀스 번호), 조립(ACK 번호)

![TCP와 UDP 헤더](3%EC%9E%A5%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%ED%86%B5%EC%8B%A0%ED%95%98%EA%B8%B0/Untitled.png)

TCP와 UDP 헤더

4계층의 상위 프로토콜 지시자는 포트 번호.

포트 번호는 목적지와 출발지를 구분해서 처리해야 해서 다양한 애플리케이션에 포트 번호를 할당하게 되는데 HTTP TCP 80, HTTPS TCP 443, SMTP TCP 25처럼 잘 알려져 있고 통상적으로 쓰고 있는 포트번호를 Well Known 포트라고 한다.

이외의 다양한 포트 번호를 할당하기 위해서는 Registered Port 범위를 사용함. (범위 : 1024~49151)

포트 번호를 할당받기 위해 IANA에 신청하면 등록되어 관리되지만 공식/비공식 번호가 섞여있거나 사설 포트 번호로 사용되기도 한다

동적, 사설, 임시포트 범위 : 49152~65535 ⇒IANA에 등록되어 사용되지 않는다. 자동 할당되거나 사설 용도로 할당되며 클라이언트의 임시 포트 번호로 사용된다.

IANA 관리 포트 확인방법 : [https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)

**3.4.2 TCP**

신뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고(3방향 핸드쉐이킹) 데이터를 분할하고 분할된 패킷이 잘 전송되었는지 확인하는 기능이 있다.

(패킷에 시퀀스 번호를 부여하고 잘 전송됐는지 응답하고 한꺼번에 얼마나 효율적으로 보낼 수 있는지 전송크기까지 고려해서 통신한다)

분할된 패킷을 잘 분할하고 수신 측이 잘 조합하도록 패킷에 시퀀스 번호로 순서를 주고 ACK로 응답 번호를 부여함.

![기본 동작 방식](3%EC%9E%A5%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%ED%86%B5%EC%8B%A0%ED%95%98%EA%B8%B0/Untitled%201.png)

기본 동작 방식

주는 쪽 : 패킷에 번호 부여 → 받는 쪽 : 번호 순서가 맞는지 확인, 번호가 맞으면 다음 번호의 패킷을 요청하는 응답을 함 ⇒ 이 때 부여하는 번호가 ACK 번호

*SYN (SYnchroize sequence Number) : 연결확인을 할 때 보내는 무작위 숫자 값*

윈도 사이즈 : 한 번에 받을 수 있는 데이터의 크기

슬라이딩 윈도 : 네트워크 상황에 따라 윈도 사이즈를 조절하는 것

슬라이딩 윈도를 하는 이유
⇒ 송신자와 수신자가 먼 거리에 떨어져 있으면 ACK를 보낸 후 왕복 지연시간(RTT)이 늘어나므로 응답을 기다리는 시간이 더 길어진다. 그래서 데이터를 보낼 때 하나가 아니라 많은 패킷을 한꺼번에 보내고 하나의 응답을 받는 게 훨씬 효율적이다. 그렇지만 네트워크 상태가 좋지 못하면 패킷이 유실될 가능성이 커지기 때문이다.

![뭔소리야](3%EC%9E%A5%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%ED%86%B5%EC%8B%A0%ED%95%98%EA%B8%B0/Untitled%202.png)

뭔소리야

만약 통신 중 데이터 유실이 발견된다면 윈도 사이즈를 절반으로 떨어뜨린 후 정상적인 통신이 된다면 서서히 하나씩 늘린다.

네트워크에 충동(경합?)이 발생해서 패킷 드롭이 생기면 윈도 사이즈가 작아져 데이터 통신 속도가 느려지고 회선을 제대로 사용하지 못하는 상황이 발생한다. 그런 경우에는 버퍼가 큰 네트워크 장비를 사용하거나 TCP 최적화 솔루션을 사용해서 문제를 해결할 수 있다.

**3.4.2.3 3방향 핸드셰이크**

안정성 중시 : 통신 시작 전 사전 연결작업을 진행한다. 

총 3번의 패킷을 주고받기 때문에 3방향 핸드셰이크임

서버는 LISTEN상태로 대기→ Client가 SYN-SENT→서버에서 SYN-RECEIVED하고 Syn,ACK로 응답→Client에서 ESTABLISHED로 변경 후 ACK 응답→서버에서 ESTABLISHED로 변경

⇒연결완료

핸드셰이크 방식이 생긴 이후 기존 통신응답과 새로운 통신시도(핸드셰이크)를 구분하기 위해 헤더에 flag 값을 넣음

- SYN : 연결 시작. 연결이 시작될 때 플래그 1로 표시해서 보냄
- ACK : ACK 번호가 유효할 경우 1로 표시해서 보냄
- FIN : 데이터 전송 마친 후 정상적으로 양방향 연결 종료 시 1로 표시.
- RST : 연결 강제 종료를 위해 한 쪽에서 연결을 일방적으로 끊을 때 1로 표시
- URG : 긴급 데이터인 경우 1로 표시
- PSH : 서버 측에서 전송할 데이터가 없거나 데이터를 버퍼링 없이 응용프로그램으로 즉시 전달할 것을 지시할 때 사용

![Untitled](3%EC%9E%A5%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%ED%86%B5%EC%8B%A0%ED%95%98%EA%B8%B0/Untitled%203.png)

**3.4.3 UDP**

4계층 프로토콜이 가져야 할 특징이 거의 없음 = 신뢰 통신을 위한 것들이 거의 없다. 비신뢰성 프로토콜답다

데이터 전송을 보장하지 않는 프로토콜이므로 제한된 용도로만 사용한다.

→ 시간에 민감한 프로토콜/애플리케이션(음성 데이터(전화), 실시간 스트리밍)

→ 다수의 단말과 통신하는 바람에 응답할 수 없는 경우 (사내 방송, 증권 시세 데이터 전송에 사용되는 멀티캐스트)

일부 데이터가 유실되더라도 지연없이 계속 전송하는 것

3방향 핸드셰이크는 없지만 첫 데이터는 리소스 확보를 위한 인터럽트 용도로 사용하고 유실된다.

![시험에 맨날 나옴](3%EC%9E%A5%20%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%ED%86%B5%EC%8B%A0%ED%95%98%EA%B8%B0/Untitled%204.png)

시험에 맨날 나옴

### 3.5 ARP

이미 정리해놓은 ARP 페이지가 있어서 그걸로 대체합니노~.~

추가로 알게 된 사항 있으면 ARP 페이지 수정해요

[ARP](../%EA%B0%9C%EB%85%90%EC%A0%95%EB%A6%AC/OSI%207%20Layer/Layer3%20(Network)/ARP%20e04b1eb55b0b4f979cbee3611a676f7a.md) 

### 3.6 서브넷과 게이트웨이

게이트웨이 : 원격지 네트워크와의 통신에 사용하는 장비

L3장비가 해당 역할을 할 수 있다

**3.6.1 서브넷과 게이트웨이의 용도**

원격지에 있는 장비에게 브로드캐스팅을 하는 것을 도와줌

기본 게이트웨이 : 여러 네트워크와 연결되면서 적절한 경로를 지정해주는 역할

목적지가 출발지와 같은 네트워크인지 식별하기 위해 활용하는 것이 서브넷마스크

참고 : [**프록시ARP**](../%EA%B0%9C%EB%85%90%EC%A0%95%EB%A6%AC/OSI%207%20Layer/Layer3%20(Network)/ARP/Proxy%20ARP%20f1aaa8ba8b5f405f814fbaf45675a1c8.md)

**3.6.2 2계층통신 VS 3계층 통신**

정확한 표현은 아님. 2계층 = 로컬 네트워크, 3계층 = 원격지 네트워크

통신하는 출발지와 도착지의 네트워크가 같으면 2계층, 다르면 3계층

외부 네트워크와 통신할 때, 단말이 직접 보낼 수 없는 목적지인 것으로 판단하고 ARP 요청을 기본 게이트웨이의 IP주소로 요청한다 → 게이트웨이에서 ARP 응답을 받은 단말은 도착지 MAC주소에 기본 게이트웨이의 MAC을 입력한다.