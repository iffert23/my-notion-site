# 6장/ 로드 밸런서/방화벽: 4계층 장비(세션 장비)

---

기존 : 2,3계층 장비 → 현재 : 4계층도 포함

### 6.1 4계층 장비의 특징

TCP같은 4계층 헤더 기반으로 동작. 세션 정보에 관한 동작이 중요하고, 4계층 이상에서 동작하는 세션 장비에는 로드 밸런서, 방화벽이 있음

고려 요소

- 세션 테이블
세션장비가 운영되는 기반.
세션 정보를 저장 확인하는 작업 전반의 이해 필요
세션정보가 테이블에 남아있는 라이프타임에 대한 고려 필요
- Symmetric 경로 요구
Indound, Outbound 경로 일치 필요
- 정보 변경(로드밸런서)
L7 로드밸런서(= ADCIP주소가 변경되며 확장됨)는 애플리케이션 프로토콜 정보도 변경됨

### 6.2 로드 밸런서

서버나 장비의 부하분산이 목적.

4계층 이상에서 동작하며 IP주소/4계층 정보/애플리케이션정보를 확인, 수정하며 트래픽을 분배함

웹 서버 부하분산을 위해 사용하는 경우가 많은데, 서버 부하분산을 위해서 내부 부품 이중화/용량이 더 큰 부품을 사용하기 위해서는 가격이 비싸므로 저렴하고 작은 장비를 여러 대 묶어 사용하는 방법이 효율적이다. 이러한 확장방법이 스케일 아웃이다.

![로드 밸런서의 역할](6%EC%9E%A5%20%EB%A1%9C%EB%93%9C%20%EB%B0%B8%EB%9F%B0%EC%84%9C%20%EB%B0%A9%ED%99%94%EB%B2%BD%204%EA%B3%84%EC%B8%B5%20%EC%9E%A5%EB%B9%84(%EC%84%B8%EC%85%98%20%EC%9E%A5%EB%B9%84)/Untitled.png)

로드 밸런서의 역할

서비스에 사용되는 대표IP주소를 서비스IP로 갖고, 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 실제IP로 변경해서 요청을 보낸다.

---

- L4 로드 밸런싱
    
    일반적인 로드 밸런서가 동작하는 방식. TCP,UDP(포트 넘버)를 기반으로만 분산 처리하는 경우
    
- L7 로드 밸런싱
    
    애플리케이션 프로토콜 정보(SMTP,HTTP,FTP 등)를 기반으로 동작한다. Proxy 역할 수행하며 ADC라고 부른다.
    

온프레미스 : L4,L7를 모두 지원, 설정방식에 따라 계층을 나눔

클라우드 : 계층별로 컴포넌트가 나뉘어져 있음, (AWS) L4=NLB(network), L7=ALB(application)

**6.2.1 L4 스위치**

내부 동작 방식은 4계층 로드밸런서지만 외형은 스위치처럼 여러 개의 포트를 가지고 있다.

다양한 네트워크 구성이 가능해서 가장 대중화되어있다.

부하분산, 성능 최적화, 리다이렉션 기능을 제공한다.

필요조건 : **가상서버**(사용자가 바라보는 실제 서비스), **가상IP**(사용자가 접근해야 하는 서비스IP), **리얼서버**(실제로 서비스를 수행하는 서버), **리얼IP**(실제 서버의 IP)

**6.2.2 ADC**

Proxy로 동작하며 다양한 부하분산, 정보 수정, 정보 필터링이 가능하다.

일부 소프트웨어 ADC를 제외한 대부분의 ADC는 4계층부터 7계층까지 로드밸런싱 기능을 제공하며 페일오버, 리다이렉션도 함께 수행한다.

외에도 캐싱, 압축, 콘텐츠변환 및 재작성, 인코딩 변환, 애플리케이션 프로토콜 최적화도 가능하다.

추가로 플러그인 형태의 보안 강화 기능을 통해 WAF/HTML,XML 검증, 변환 수행도 가능하다.

**6.2.3 L4스위치 vs ADC**

L4 : TCP, UDP 계층 기반의 부하 분산, 최적화, 보안 기능. TCP 레벨의 간단한 DoS 공격 방어가 가능하다

++스케일 업, 스케일 아웃 차이점

### 6.3 방화벽

네트워크 중간에 위치해서 통과하는 트래픽을 정책조건에 맞게 허용/차단하는 장비

3, 4계층에서 동작하며 세션을 인지,관리하는 SPI 엔진을 기반으로 동작하는 장비를 방화벽이라고 함

NAT와 유사하며 세션정보를 장비 내부 세션테이블에 저장해서 패킷의 인과 관계를 가려낸다.

기본 정책 : 인터넷으로 나가는 모든 패킷을 허용하고 내부로 들어오는 모든 패킷을 차단하는 것

++상태 테이블(상태정보 인지, stateful로 동작)=세션 테이블(해당 상태에 대한 세션 값을 유지)

둘 다 비슷함

### 6.4 4계층 장비를 통과할 때의 유의점 (세션 관리)

세션테이블 정보를 이용해서 패킷 포워드/드롭 for 패킷변경, 애플리케이션 성능 최적화, 보안 강화

애플리케이션의 세션 시간, 서비스 방향성을 고려하고 **비대칭 경로를 피하는 것**이 매우 중요

**6.4.1 세션 테이블 유지, 세션 정보 동기화**

종단 장비 간의